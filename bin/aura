#! /usr/bin/ruby

require 'open-uri'
require 'fileutils'
require_relative '../lib/aura'

unless ARGV.size == 1
  $stderr.puts "package?"
  exit 1
end

env = Environment.new
env.test  = "test"
env.temp  = "temp"
env.redo  =  true
env.todo  = ARGV[0]

if env.redo or !env.cd?

  FileUtils.rm_rf env.test+env.todo rescue false

  package  = "https://aur.archlinux.org/#{env.todo}.git"

  command  = "git clone --quiet "
  command += package + " "
  command += env.test + env.todo

  Console << [:aur, package]
  system command 

  unless env.cd?
    $stderr.puts "package?!"
    exit 1
  end

end

pkgbuild = Pkgbuild.new

unless pkgbuild.ok?
  $stderr.puts "pkgbuild?"
  exit 1
end

srcdir = File.expand_path(pkgbuild["pkgname"], env.temp)

if env.redo
  FileUtils.rm_rf(srcdir)
end

unless File.exists? srcdir

  Dir.mkdir(srcdir)

  p pkgbuild["source"]
  pkgbuild["source"].each do |path|
    Request.new(path, srcdir) rescue
    begin
      $stderr.puts "sauce?"
      exit 1
    end
  end

end

pkgbuild << {"srcdir" => srcdir}
build = pkgbuild["build()"]
system(build)
