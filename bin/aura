#! /usr/bin/ruby

require 'net/http'
require 'open-uri'
require 'fileutils'
require_relative '../lib/aura'

Signal.trap('INT') { puts; exit 1 }

unless ARGV.size == 1
  $stderr.puts "package?"
  exit 1
end

env = Environment.new
env.aurs = "test/aurs"
env.pkgs = "test/pkgs"
env.root = "test/root"
env.redo =  false
env.todo =  ARGV[0]
env.init

if env.redo or !File.directory?(env.aurs + env.todo)

  FileUtils.rm_rf(env.aurs + env.todo) rescue false

  package = "https://aur.archlinux.org/#{env.todo}.git"
  gitfile = env.aurs + env.todo
  command = String.new

  command << "git clone --quiet "
  command << package << " "
  command << gitfile

  Console << [:aur, package]

  pipe = Pipe.new
  pipe.command = command
  pipe.go!

  if pipe.out.start_with? "warning"
    FileUtils.rm_rf gitfile
    $stderr.puts "package?!"
    exit 1
  end

end

Dir.chdir(env.aurs + env.todo)
pkgbuild = Pkgbuild.new

unless pkgbuild.ok?
  $stderr.puts "pkgbuild?"
  exit 1
end

srcdir = File.expand_path(pkgbuild["pkgname"], env.pkgs)

if env.redo
  FileUtils.rm_rf(srcdir)
end

unless File.exists? srcdir

  Dir.mkdir(srcdir)

  pkgbuild["source"].each do |path|
    Source.new(path, srcdir) rescue
    begin
      $stderr.puts "source?!"
    end
  end

end

pkgbuild << {"srcdir" => srcdir}
pkgbuild << {"pkgdir" => env.root}

["prepare", "build", "package"].each do |func|

  body = pkgbuild[func + "()"]
  next if body.nil?

  pipe = Pipe.new
  pipe.command = body
  pipe.go!

end
